\documentclass[12pt,letterpaper]{article}
\usepackage[T1]{fontenc}
\usepackage{graphicx} % Required for inserting images
\usepackage{listings}
\usepackage{xcolor}
\usepackage{amsfonts}
\usepackage{mathptmx}
\usepackage{amsmath}
\usepackage[numbers]{natbib}
\usepackage{tikz}
\usepackage[table]{xcolor}
\usepackage{soul}
\usepackage{array}
\usepackage{stmaryrd}
\usepackage{hyperref} % Placed here in the preamble
\usepackage{subcaption}
\RequirePackage[left=3cm,right=3cm,top=3cm,bottom=3cm]{geometry} 
\newcommand{\HRule}{\rule{\linewidth}{0.5mm}}
\hypersetup{
    colorlinks=true,
    linkcolor=black,
    filecolor=magenta,      
    urlcolor=cyan,
    pdftitle={Compte_rendu_du_projet_recherche_INF808-AM},
    pdfpagemode=FullScreen,
}


\definecolor{lightgray}{rgb}{0.8, 0.8, 0.8} % Define a custom light gray color
\definecolor{green}{rgb}{0.0, 0.5, 0.0} % Green for low risk
\definecolor{yellow}{rgb}{1.0, 1.0, 0.0} % Yellow for medium risk
\definecolor{red}{rgb}{1.0, 0.0, 0.0} % Red for high risk
\definecolor{blue}{rgb}{0.0, 0.0, 1.0} % Blue for very low risk


\title{Compte rendu - Projet Recherche - Emulation d'APT par Caldera et Analyse}
\author{Paul SCHELLER}
\date{Mars 2025}

\begin{document}
\input{code}
\input{front_page}

\newpage
\renewcommand{\contentsname}{Plan de l'étude}
\tableofcontents


\newpage
\section{Introduction}

À l'heure où les technologies prennent toujours plus de place dans les infrastructure des entreprises et dans notre quotidien, de nouvelles menaces surgissent.
Ces dernières évoluent rapidement et représentent un réel danger que ce soit pour les entreprises comme pour les consommateurs.

\bigskip

Ainsi, il est important de se prémunir de ces menaces par la mise en place progressive et proactive de contrôles de sécurité.
C'est pourquoi ce projet vise à reproduire des attaques ou ensembles d'attaques connues en s'appuyant sur le cadre MITRE ATT\&CK.
Pour cela, nous utiliserons l'outil d'émulation Caldera puis l'attaque sera analysé et détecté à l'aide d'un EDR comme Aurora.
Enfin, nous traiterons les données obtenues à l'aide d'outils comme le Windows Event Viewer.

\bigskip

L'objectif de cette étude est de comprendre le comportement des attaquants dans un premier temps.
Puis, d'évaluer la difficulté de détection d'une attaque soigneusement préparée.
Nous essaierons ensuite de lier les données obtenues avec le cadre MITRE ATT\&CK pour tenter de retrouver les APTs émulés.
Cette étude va également nous permettre de renforcer nos connaissances établis lors du cours INF808.

\bigskip

Pour mener à bien cette analyse, nous avons concentré nos efforts sur la prise en main et la compréhension des outils Caldera et Aurora EDR.
Ainsi, nous avons pu émuler plusieurs APT afin de récupérer des journaux pertinents pour évaluer la possibilité d'identifier quel type d'attaque était mené afin d'y remédier.

\newpage
\section{Objectifs}

Le projet a pour objectif principal de comprendre et d'améliorer l'efficacité des équipes de défenses en cybersécurité.
Pour ce faire, notre recherche va s'orienter autour de trois grands axes de la cybersécurité :  
\begin{enumerate}
    \item L'émulation d'attaques.
    \item La réaction aux attaques.
    \item L'analyse des journaux.
\end{enumerate}
Par conséquent, pour réaliser à bien ce projet, on peut définir les sous-objectifs suivants :
\begin{itemize}
    \item Comprendre le comportement des attaquants et leurs méthodes.
    \item Déployer un environnement d'émulation fonctionnel.
    \item Exploiter le cadre MITRE ATT\&CK pour récupérer et comprendre des attaques connues.
    \item Comprendre et maitrîser l'émulation d'attaque.
    \item Être capable de trier et d'analyser des journaux, à l'aide d'outils comme des EDR afin de détecter des attaques potentielles.
    \item Analyser les résultats obtenus.
    \item Conclure sur l'efficacité de la méthode.
    \item Établir des recommandations sur des possibilité d'amélioration de la méthode.
\end{itemize}

Ce projet nous permet donc de mettre en place un cadre de travail pour réaliser divers attaques trouvées à l'aide de l'outil MITRE ATT\&CK.
Nous pourrons ensuite analyser les résultats pour tenter de corréler les journaux avec les attaques.
Cela nous permettra de mieux comprendre le déroulement de ces actions et de saisir les difficultés qui en ressortent.

\newpage
\section{État de l'art}
La base de données MITRE ATT\&CK est un cadre de connaissance qui regroupe les différentes techniques, tactiques et procédures (TTP) utilisées par les cybercriminels. 
C'est un cadre de référence pour les équipes de sécurité afin de mieux comprendre le comportement des attaquants et d'améliorer la détection et la réponse aux incidents.

\bigskip

Pour les entreprises, il peut être intéressant de simuler des attaques afin de tester la sécurité de leurs systèmes d'informations.
C'est pourquoi divers outils existent pour émuler des attaques tels que Caldera, Metasploit ou encore Cobalt Strike.
Ces deux derniers sont cependants des outils manuels. Or, simuler le comportement d'un attaquant est une tâche complexe et fastidieuse.
Ainsi disposer d'outils permettant d'automatiser cette tâche est un réel atout pour les entreprises.

\bigskip

Caldera est un outil open-source développé par MITRE qui permet d'émuler des attaques en utilisant les TTP du cadre MITRE ATT\&CK.
Il est conçu pour aider les équipes de sécurité à tester la détection et la réponse aux incidents.
Caldera est modulaire et peut être adapté aux besoins spécifiques des entreprises.
L'outil inclut notamment des tactiques développées par Atomic Red Team, un groupe de recherche qui développe des techniques d'émulation d'attaques.
De plus, divers projets visant à émuler des APTs existent, on trouve des exemples sur Youtube ou encore sur des plateformes de formation comme TryHackMe.

\bigskip

Quant à l'analyse des journaux, c'est une tâche essentielle pour détecter les attaques et comprendre le comportement des attaquants.
Les EDR (Endpoint Detection and Response) sont des outils qui permettent de collecter et d'analyser les journaux d'événements sur les terminaux.
Ils utilisent ensuite les données récolter pour fournir une réponse automatique et adaptée aux incidents.
Dans le domaine, il existe de nombreux outils comme SentinelOne, CrowdStrike ou encore Aurora EDR.
Ce dernier est vendu comme une solution légère et particulièrement personalisable.
De plus, une version gratuite est disponible pour un usage restreint.

\bigskip

Aurora utilise les Windows Event pour remonter les comportements suspects qu'il détecte.
Windows dispose d'une interface graphique pour visualiser les journaux d'événements, mais il est également possible de les analyser à l'aide de PowerShell.
Cette dernière méthode est particulièrement intéressante car elle permet d'automatiser l'analyse des journaux à l'aide d'un language puissant et flexible.

\newpage
\section{Les Outils}

\subsection{MITRE ATT\&CK}

\subsubsection{Description}

L'organisation MITRE a conçu un cadre de connaissance permettant de rassembler les différentes techniques, tactiques et procédures (TTP) utilisées par les cybercriminels.
Ce cadre s'appelle MITRE ATT\&CK (Adversarial Tactics, Technics and Common Knowledge).
Cette base de connaissance ouverte recense le comportement des attaquants au cours des différentes phases d'une attaque. 
Elle offre un cadre commun pour tous les acteurs de la cybersécurité, qu'ils soient offensifs ou défensifs.

\subsubsection{Structure}

L'outil est segmenté en plusieurs matrices selon les différents environnements et surfaces d'attaques :
\begin{itemize}
    \item Entreprise (Windows, Linux, MacOS, Cloud, ...).
    \item Mobile (Android, IOS).
    \item ICS (Système de contrôle industriel).
\end{itemize}

\subsubsection{Objectifs}

Les objectifs de l'outil sont les suivants :
\begin{itemize}
    \item \textbf{Cartographier les attaques} pour mieux les comprendre.
    \item \textbf{Améliorer l'identification et la détection} des attaques.
    \item \textbf{Renforcer la défense} par la proposition de diverses mitigations.
    \item \textbf{Établir un cadre commun} pour les acteurs du monde de la cybersécurité.
\end{itemize}

\subsubsection{Applications}

L'outil peut être utilisé pour :
\begin{itemize}
    \item \textbf{Analyser les menaces}.
    \item \textbf{Supporter les équipes défensives comme offensives}.
    \item \textbf{Servir de base de données} pour les outils de type SIEM, EDR, etc.
\end{itemize}

\subsection{Caldera}

\subsubsection{Description}

L'outil Caldera a été conçu par MITRE pour aider les entreprises à améliorer la sécurité de leurs systèmes d'informations.
Pour ce faire, la plateforme open-source permet d'émuler des techniques du cadre MITRE ATT\&CK ou d'en créer directement depuis l'outil.
Il permet d'automatiser les tests des équipes rouges.

\subsubsection{Fonctionnalités}

Les fonctionnalités du logiciel sont les suivantes :
\begin{itemize}
   \item \textbf{Automatiser les tests} des équipes offensives.
   \item \textbf{Moduarité} pour permettre d'adapter le logiciel aux besoins des entreprises.
   \item \textbf{Interopérabilité}.
   \item \textbf{Interface visuel et intuitive}.
   \item \textbf{Environnement de test} pour effectuer des tests dans un environnement controlé et sûr.
\end{itemize}

\subsubsection{Objectifs}

Le logiciel a été conçu pour répondre aux besoins suivants :
\begin{itemize}
    \item \textbf{Tester la détection des attaques} par les dispositifs de sécurité de l'entreprise.
    \item \textbf{Automatiser les tests} des équipes offensives.
    \item \textbf{Former les équipes de défense} à réagir aux attaques informatiques.
\end{itemize}

\subsubsection{Cas d'usage}

Les cadre d'utilisation de la plateforme sont les suivants :
\begin{itemize}
    \item \textbf{Red Teaming et Blue Teaming}.
    \item \textbf{Tests des outils de détection} (SIEM, EDR, etc.).
    \item \textbf{Former les équipes}.
\end{itemize}

\subsection{Aurora EDR}

Aurora EDR est une solution de détection et de réponse des terminaux (EDR) développée par Nextron Systems.
Aurora utilise l'intelligence artificielle et l'analyse comportementale pour détecter des activités suspectes à la différence de la majorité des EDR qui se base sur les signatures. 
Notre choix s'est porté sur Aurora pour analyser les journaux car il tourne localement sur les terminaux, réduisant donc l'impact sur les ressources système et limitant les fuites de données sensibles à l'extérieur du réseau.
L'outil peut fonctionner sur des systèmes aux ressources limitées, grâce à sa légereté et son efficacité, faisant de ce dernier un bon choix.

\bigskip

De plus, Aurora utilise les règles Sigma pour établir des profils et détecter des menaces, tout en étant totalement transparent.
Ces règles proviennent de la communauté open-source et sont utilisées par de nombreux outils de détection.
Cela permet d'utiliser un autre cadre commun et supporté par de nombreux outils de sécurité.
Il est par exemple possible d'écrirer des règles Sigma pour détecter des menaces spécifiques et de les intégrer dans Aurora.



\subsubsection{Fonctionnalités}

Aurora possède de nombreuses fonctionnalités dont les principales sont :
\begin{itemize}
    \item \textbf{Détecter les comportements anormaux} en temps réel.
    \item \textbf{Identifier les menaces} basés sur des schémas d'attaques, en cherchant les déviances avec des comportements normaux.
    \item \textbf{Répondre aux incidents} pour les isoler et y remédier.
    \item \textbf{Rechercher des signes d'intrusions avancés}
    \item \textbf{Mettre en lien les résultats d'analyse} avec les données du cadre MITRE ATT\&CK.
    \item \textbf{Journaliser} les événements pour une analyse ultérieure.
\end{itemize}

\subsubsection{Avantages de l'outil}

L'outil représente un atout pour les entreprises de part sa capacité à réaliser les tâches suivantes :
\begin{enumerate}
    \item Détecter des menaces avancées.
    \item Réagir rapidement aux attaques en appliquant automatiquement des mitigations.
    \item Renforcer la posture de sécurité de l'entreprise.
    \item Faciliter les investigations.
\end{enumerate}

\subsubsection{Application}

Aurora EDR est principalement utilisé pour répondre aux besoins suivants : protéger les système contre les rançongiciels, détecter des APTs, automatiser la réponse aux incidents et aider les enquêteurs.

\bigskip

Dans notre cas, nous utiliserons principalement Aurora EDR pour aider à la détection des APTs au travers les journaux de Windows.

\subsection{Tailscale}

\subsubsection{Description}

Tailscale est un outil qui permet de réaliser un réseau virtuel privé (VPN).
Il se base sur le protocole WireGuard, reconnu pour son efficacité, sa rapidité et sa sécurité.
Ce qui distingue Tailscale des autres solutions VPN, c'est sa simplicité de déploiement et sa capacité à créer des réseaux maillés entre plusieurs appareils, sans nécessiter de configuration complexe.
Tailscale est particulièrement adapté pour les environnements de travail distribués, où les utilisateurs peuvent se connecter à des ressources internes de manière sécurisée, même lorsqu'ils sont éloignés physiquement du réseau d'entreprise.
Ce réseau virtuel crée par Tailscale est appelé \textit{Tailnet}.

\bigskip

De fait, l'outil va permet de créer une infrastructure pour le projet avec le déploiement de Caldera et d'une machine virutelle cible sur Windows.
Chaque machine peut communiquer directement avec l'autre et cela va nous permettre de travailler sur le projet de manière efficace sans nécessité de se connecter à un réseau local configuré.
Ci-dessous, un schéma de l'architecture de notre projet :
\begin{figure}[!h]
    \centering
    \includegraphics[width=0.5\textwidth]{images/infra_scheme.png}
    \caption{Architecture de l'environnement de travail}
    \label{fig:architecture}
\end{figure}
\subsubsection{Fonctionnalités}

Les principales fonctionnalités de Tailscale incluent :
\begin{itemize}
    \item \textbf{Configuration simplifiée} : Configuration automatisée de l'infrastructure réseau (routage, contrôle des accès, DNS, ...).
    \item \textbf{Sécurité renforcée} : Chiffrement avec Wireguard.
    \item \textbf{Accès à distance} : Permet de se connecter au réseau même à distance.
    \item \textbf{Gestion des identités} : Tailscale utilise des ACL pour contrôler l'accès aux ressources. Il s'intègre avec des systèmes d'authentification tiers comme Google, Microsoft, Okta, etc.
    \item \textbf{Interopérabilité} : Fonctionne sur plusieurs plateformes comme Windows, macOS, Linux, iOS et Android.
\end{itemize}

\subsubsection{Avantages}

Tailscale présente plusieurs avantages tels que :
\begin{itemize}
    \item \textbf{Facilité de prise en main} : Il suffit d'installer le client sur les appareils et de se connecter avec un compte ou une clé.
    \item \textbf{Performance} : Faible latence et faible consommation de ressources grâce à WireGuard.
    \item \textbf{Sécurité} : Chiffrement de bout en bout et gestion fine des autorisations.
\end{itemize}

\subsubsection{Cas d'usage}

Tailscale peut être utilisé dans divers scénarios :
\begin{itemize}
    \item \textbf{Accès sécurisé aux ressources internes} : Par exemple, accéder à des serveurs ou bases de données internes.
    \item \textbf{Collaboration entre équipes distantes} : Permet de travailler ensemble sur un même réseau, une même infrastructure mais à distance
    \item \textbf{Administration système} : Gérer des machines distantes sans exposer les ports au public.
    \item \textbf{Création de réseaux privés temporaires} : Pour des projets ou des tests spécifiques.
\end{itemize}

\newpage
\section{Déroulement du Projet}

L'étude est composée de plusieurs étapes clées : \\
Dans une premier temps, nous allons réaliser une étude préalable pour comprendre et maîtriser les différents outils présentés précedemment.
Ensuite, nous allons émuler plusieurs APT afin d'évaluer l'efficacité de l'outil Caldera dans un premier temps.
Puis, dans un second temps, nous analyserons l'utilité des outils de détection comme Aurora ainsi que les difficultés liées.
Enfin, nous conclurons quant à l'utilité et les forces des outils présentés 

\subsection{Étude préalable}
\subsubsection{Installation des outils}

La première étape de l'étude a consisté à installer les différents outils présentés précédemment.

\bigskip

Pour commencer, nous avons utiliser Tailscale pour créer un réseau virtuel qui nous sert d'environnement de travail.
Ensuite, nous avons instancié Caldera à l'aide de Docker.
Nous avons rencontré ensuite certaines difficultés pour faire fonctionner Caldera dans ce conteneur mais aussi à se connecter à l'interface web depuis une autre machine du réseau Tailscale.
Enfin, nous avons déployer une machine virtuelle Windows serveur 2019 sur laquelle nous avons installé l'EDR Aurora.
Par la suite nous avons configuré un Active Directory (AD) sur cette même machine pour une simulation plus proche d'un environnement d'entreprise.

\subsubsection{Prise en main des outils}
\begin{enumerate}
    \item \textbf{Caldera} : 
    Pour prendre en main l'outil Caldera, il nous a fallu commencer par comprendre comment fonctionne l'émulation d'attaque.
    Ainsi, nous avons utilsés les salles de \textit{TryHackMe} à ce sujet. \\

    Pour cela nous avons dans un premier temps appris le concept d'émulation d'attaque, non seulement d'un point de vue technique mais aussi d'un point vue entreprise (entente avec l'entreprise cible, méthodologie, rapport).
    Dans un second temps, nous avons mis en pratique nos connaissances via l'outil \verb|Invoke-Atomic| développé par le groupe Atomic Red Team pour l'émulation d'APT, de techniques via Powershell. \\

    Enfin nous avons réaliser le cours sur l'outil Caldera qui nous a appris à manier l'outil et ses différentes facettes. 

    \item \textbf{Windows \- Event Manager} :
    Afin de mieux comprendre comment fonctionne les attaques d'un point de vue de la victime et l'EDR Aurora, nous avons décider d'apprendre et de comprendre la gestion des journaux sur Windows.
    Ainsi, nous avons utilisé les outils suivant : \verb|Get-WinEvent|, \verb|wevtutil.exe| ou encore \verb|XPath Queries|.
    Nous avons utilisé la salle TryHackMe associée.
    Cela nous a permis de comprendre la formes des techniques au sein des journaux, ainsi que la manière de les trier et de les analyser. \\
    
    \item \textbf{Aurora EDR} :
    Nous avons ensuite pris en main l'outil Aurora EDR.
    Pour cela, nous avons utilisé la documentation de l'outil qui nous a permis de comprendre comment fonctionne l'outil et comment il s'intègre dans notre environnement.
    Puis, nous avons réaliser la leçon de mise en pratique de TryHackMe. \\
\end{enumerate}

\newpage
\subsection{Premier scénario}
L'objectif de ce premier scénario était de prendre en mains les diverses aspects de Caldera dont les :
\begin{itemize}
    \item Techniques
    \item Adversaires
    \item Opérations
\end{itemize}

Dans ce dernier, nous avions pour objectif de simuler une attaque simple.
Ainsi, nous avons choisi d'effectuer une extraction de données sur le système cible Windows Server.

Pour cela, nous avons créer deux techniques :
\begin{itemize}
    \item \textbf{T1005} : Data from Local System
    \item \textbf{T1003.003} : Exfiltration Over Web Service : Exfiltration to Cloud Storage
\end{itemize}

La première technique utilise l'outil \verb|ntdsutil| pour exfiltrer les données de l'Active Directory.
C'est un outil de ligne de commande qui permet d'interagir avec la base de données Active Directory.
Il est utilisé pour effectuer des opérations de maintenance et de gestion sur les bases de données AD.
Il permet notamment d'extraire la base de données AD, de la sauvegarder ou de la restaurer.

Ainsi, nous allons générer le fichier \verb|ntds.dit| qui contient les informations de l'Active Directory à l'aide de la commande suivante :
\lstinputlisting[caption={Data From Local System}]{../scripts/Get-NTDS.ps1}

On retrouvera donc la base de données de l'Active Directory \verb|ntds.dit| dans le répertoire \verb|C:\Windows\Temp\NTDS\Active Directory\|.
La seconde technique utilise un serveur web externe pour exfiltrer ces données à l'aide d'une requête POST :
\lstinputlisting[caption={Exfiltration Over Web Service}]{../scripts/Push-NTDS.ps1}
Cette commande va permettre d'exfiltrer le fichier \verb|ntds.dit| vers le serveur web externe qui se trouve également sur le Tailnet. \\

Nous avons ensuite créé un adversaire qui va utiliser ces deux techniques dans la partie \textit{Adversaries} de Caldera.
Il s'agit ici de l'adversaire \textbf{APT0}, un adversaire fictif pour ce premier scénario.

\begin{figure}[h!]
    \centering
    \includegraphics[width=1\textwidth]{images/caldera/apt0_adversary.png}
    \caption{Adversaire APT0}
    \label{fig:apt0_adversary}
\end{figure}

Finalement, nous pouvons lancer une opération et observer le résultat sur Caldera.
On retrouve bien les deux techniques définies précédemment.
On remarque que les deux techniques ont bien été exécutées, sur l'hôte WIN-41SLDMUH9VC et que la sortie de la seconde commande affiche bien un succès.
Ce qui signifie que la base de données a bien été extraite puis exfiltrée vers le serveur web externe.

\begin{figure}[h!]
    \centering
    \begin{subfigure}{0.95\textwidth}
        \centering
        \includegraphics[width=1\textwidth]{images/caldera/apt0_operation.png}
        \caption{Affichage des techniques utilisées}
        \label{fig:apt0_operation_1}
    \end{subfigure}
    \begin{subfigure}{0.3\textwidth}
        \centering
        \includegraphics[width=1\textwidth]{images/caldera/apt0_operation_result.png}
        \caption{Résultat de la seconde technique}
        \label{fig:apt0_operation_2}
    \end{subfigure}
    \caption{Opération pour APT0}
\end{figure}

Ainsi, nous avons pu émuler une attaque simple à l'aide de Caldera en utilisant les techniques du cadre MITRE ATT\&CK.

\newpage
\subsection{Second scénario}

Dans ce second scénario, nous allons émuler une attaque plus complexe.
Nous avons choisi d'émuler l'APT \textbf{AKIRA} qui est un rançongiciel.

Voici les techniques utilisées d'après le cadre MITRE ATT\&CK \cite{AkiraGOLDSAHARA} :
\begin{table}[h!]
    \centering
    \begin{tabular}{|l|l|p{10cm}|}
        \hline
        \textbf{Domain} & \textbf{ID} & \textbf{Name and Use} \\ \hline
        Enterprise & T1531 & \textbf{Account Access Removal}: Akira deletes administrator accounts in victim networks prior to encryption. \\ \hline
        Enterprise & T1560.001 & \textbf{Archive Collected Data: Archive via Utility}: Akira uses utilities such as WinRAR to archive data prior to exfiltration. \\ \hline
        Enterprise & T1486 & \textbf{Data Encrypted for Impact}: Akira encrypts files in victim environments as part of ransomware operations. \\ \hline
        Enterprise & T1213.002 & \textbf{Data from Information Repositories: SharePoint}: Akira has accessed and downloaded information stored in SharePoint instances as part of data gathering and exfiltration activity. \\ \hline
        Enterprise & T1482 & \textbf{Domain Trust Discovery}: Akira uses the built-in Nltest utility or tools such as AdFind to enumerate Active Directory trusts in victim environments. \\ \hline
        Enterprise & T1567.002 & \textbf{Exfiltration Over Web Service: Exfiltration to Cloud Storage}: Akira will exfiltrate victim data using applications such as Rclone. \\ \hline
        Enterprise & T1133 & \textbf{External Remote Services}: Akira uses compromised VPN accounts for initial access to victim networks. \\ \hline
        Enterprise & T1657 & \textbf{Financial Theft}: Akira engages in double-extortion ransomware, exfiltrating files then encrypting them, in order to prompt victims to pay a ransom. \\ \hline
        Enterprise & T1219 & \textbf{Remote Access Software}: Akira uses legitimate utilities such as AnyDesk and PuTTy for maintaining remote access to victim environments. \\ \hline
        Enterprise & T1018 & \textbf{Remote System Discovery}: Akira uses software such as Advanced IP Scanner and MASSCAN to identify remote hosts within victim networks. \\ \hline
        Enterprise & T1078 & \textbf{Valid Accounts}: Akira uses valid account information to remotely access victim networks, such as VPN credentials. \\ \hline
    \end{tabular}
    \caption{Techniques utilisées par le rançongiciel Akira}
    \label{tab:akira_techniques}
\end{table}

Nous avons donc créé un adversaire qui utilise ces techniques.
Dans la liste des cacacités proposés par Caldera (provenant d'Atomic Red Team), nous avons choisi d'utiliser les capacités les plus proches des descriptions fournies par MITRE ATT\&CK.
Nous avons donc utilisé les capacités suivantes :

\begin{figure}[h!]
    \centering
    \includegraphics[width=1\textwidth]{images/caldera/akira_adversary.png}
    \caption{Adversaire APT AKIRA}
    \label{fig:akira_adversary}
\end{figure}

Cependant, il a fallu corriger certaines capacités pour qu'elles soient compatibles avec notre environnement. 

\bigskip

Une fois les opérations menées, il reste à analyser les journaux de l'EDR Aurora pour voir si les techniques ont bien été détectées.
Pour cela, il suffit de lancer l'outil Aurora et de se rendre dans l'application Event Viewer de Windows.
Les journaux d'Aurora se trouvent dans le cannal \verb|Application| et la source est \verb|AuroraAgent|.
Dans les captures d'écrans \ref{fig:event_viewer_1} et \ref{fig:event_viewer_2} ci-dessous, un exemple de journal d'Aurora vu dans l'Event Viewer de Windows.

\begin{figure}[h!]
    \centering
    \begin{subfigure}{0.85\textwidth}
        \centering
        \includegraphics[width=1\textwidth]{images/windows/event_viewer1.png}
        \caption{Première partie du journal}
        \label{fig:event_viewer_1}
    \end{subfigure}
    \begin{subfigure}{0.85\textwidth}
        \centering
        \includegraphics[width=1\textwidth]{images/windows/event_viewer2.png}
        \caption{Seconde partie du journal}
        \label{fig:event_viewer_2}
    \end{subfigure}
    \caption{Event Viewer Windows : journaux d'Aurora}
    \label{fig:event_viewer}
\end{figure}

\bigskip

On remarque donc qu'Aurora a bien détecté l'attaque et mentionne également des techniques utilisées par l'attaquant, ici T1219, dans la partie \textit{Data} de l'onglet détails.
Si l'on regarde dans la liste des techniques de l'attaquant, on remarque que la technique T1219 est bien présente dans la liste des techniques utilisées par l'attaquant.
Il s'agit de la technique \textbf{Remote Access Software} qui correspond à l'utilisation de logiciels de prise de contrôle à distance comme AnyDesk ou PuTTy.

\newpage

À présent, nous avons voulu automatiser la recherche de journaux d'Aurora.
Pour cela, nous avons utilisé le module \verb|Get-WinEvent| de PowerShell.
Celui-ci permet de récupérer les journaux d'événements de Windows.
Il est possible de filtrer pour ne récupérer que les événements d'Aurora.
\begin{itemize}
    \item \textbf{ID} : ID de l'événement
    \item \textbf{TimeCreated} : Date et heure de création de l'événement
    \item \textbf{TTP} : TTP utilisé
    \item \textbf{Level} : Niveau de l'événement selon Aurora
    \item \textbf{CommandLine} : Ligne de commande utilisée
    \item \textbf{ParentCommandLine} : Ligne de commande du processus parent
\end{itemize}

Ci-dessous, l'extrait du premier script qui permet de récupérer les informations suivantes provenants des journaux d'Aurora :

\begin{lstlisting}[caption={Récupération des journaux d'Aurora}, label={lst:aurora_logs}]
$events = Get-WinEvent -LogName "Application" -FilterXPath "*[System[Provider[@Name='AuroraAgent']]]"
\end{lstlisting}

On utilise la commande \verb|Get-WinEvent| avec un filtre XPath pour ne récupérer que les événements d'Aurora.
XPath est un langage de requête qui permet de sélectionner des nœuds dans un document XML, il a été créé par W3C \cite{XMLPathLanguage}.
Ce premier script nous permet d'obtenir les TTP les plus courantes repérées par Aurora.
Dans nos essais, le script a pu travailler sur 1135 événements d'Aurora et a pu extraire 282 TTPs, avec l'ajout de quelques commandes pour filter le résultat on obtient :

\begin{lstlisting}[caption={Recherche des TTP dans les journaux d'Aurora}, label={lst:ttp_logs}]
PS C:\Users\Administrator> .\Get-TTP.ps1 | Group-Object -Property TTP | ForEach-Object {[PSCustomObject]@{
    TTP = $_.Name
    Count = $_.Count
    EventDetail = $_.Group
}} | Sort-Object -Property Count

    TTP       Count EventDetail
    ---       ----- -----------
    T1027.004     1 {@{TPP=T1027.004;...
    T1047         1 {@{TPP=T1047;...
    T1562.004     2 {@{TPP=T1562.004;...
    T1059.001     2 {@{TPP=T1059.001;...
    T1053.005     7 {@{TPP=T1053.005;...
    T1560.001    18 {@{TPP=T1560.001;...
    T1087.002    27 {@{TPP=T1087.002;...
    T1219       224 {@{TPP=T1219;...
\end{lstlisting}

On obtient un tableau avec les TTPs, le nombre d'occurrences et les détails des événements liés au TTP.
On peut donc avoir tous les événements liés à un TTP en particulier.
On remarque aussi que la technique T1219 est la plus courante dans les journaux d'Aurora.
Ainsi, il est possible de récupérer certaines TTPs émulées par Caldera.

\bigskip

Ensuite, nous avons voulu savoir si ces TTPs étaient utilisées par des APTs.
Pour cela, nous avons utilisé le second script \verb|Match-TTP-APT.ps1| qui permet de comparer les TTPs extraites avec la base de données MITRE ATT\&CK.
La combinaison des deux scripts nous permet d'obtenir une liste d'APT qui seraient susceptibles d'utiliser les TTP repérées par Aurora.
\begin{lstlisting}[caption={Identification des APTs}, label={lst:apt_logs}]
PS C:\Users\Administrator> .\Get-TTP.ps1 | Group-Object -Property TPP | ForEach-Object {[PSCustomObject]@{
    TTP = $_.Name
    Count = $_.Count
    EventDetail = $_.Group
}} | Sort-Object -Property Count | .\Match-TTP-APT.ps1

    [+] Analyse des TTP extraits avec MITRE ATT&CK...
    [*] Téléchargement de la base ATT&CK...

    ==== TOP GROUPES IDENTIFIÉS ====

    GroupName     MatchCount MatchingTTPs
    ---------     ---------- ------------
    MuddyWater             7 T1027.004, T1047, T1053.005, T1059.001, T1087.002, T1219, T1560.001
    ToddyCat               6 T1047, T1053.005, T1059.001, T1087.002, T1560.001, T1562.004
    FIN13                  5 T1047, T1053.005, T1059.001, T1087.002, T1560.001
    Mustang Panda          5 T1047, T1053.005, T1059.001, T1219, T1560.001
    menuPass               5 T1047, T1053.005, T1059.001, T1087.002, T1560.001
    Wizard Spider          5 T1047, T1053.005, T1059.001, T1087.002, T1560.001
    Magic Hound            5 T1047, T1053.005, T1059.001, T1560.001, T1562.004
    Kimsuky                5 T1053.005, T1059.001, T1219, T1560.001, T1562.004
    Chimera                5 T1047, T1053.005, T1059.001, T1087.002, T1560.001
    APT41                  5 T1047, T1053.005, T1059.001, T1087.002, T1560.001
\end{lstlisting}

Au final, on obtient une liste d'APT qui utilisent les TTPs repérées par Aurora.
L'APT Akira ne fait pas partie de la liste.

\section{Observation}

APT trouvées correspondent pas à AKIRA
=> Tous les TTPs ne sont pas forcément détectés par Aurora
=> méthode pas forcément fiable

\section{Conclusion}



\newpage
\section{Listings}
\lstinputlisting[caption={Exfiltration Over Web Service}, label={get-ttp}]{../scripts/Get-TTP.ps1}

\lstinputlisting[caption={Exfiltration Over Web Service}, label={match-ttp}]{../scripts/Match-TTP-APT.ps1}

\newpage
\bibliographystyle{unsrtnat} % or any other style like apalike, alpha, etc.
\bibliography{bib/main}

\end{document}

